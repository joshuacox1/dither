use std::cmp;

use crate::types::Vec3f;

pub struct KDTree {
    location: f32,
    left: Box<KDTree>,
    right: Box<KDTree>,
}

fn sortx(v1: &Vec3f, v2: &Vec3f) -> cmp::Ordering {
    f32::total_cmp(v1.0, v2.0)
}

fn sorty(v1: &Vec3f, v2: &Vec3f) -> cmp::Ordering {
    f32::total_cmp(v1.1, v2.1)
}

fn sortz(v1: &Vec3f, v2: &Vec3f) -> cmp::Ordering {
    f32::total_cmp(v1.2, v2.2)
}

const SORT_FNS: [fn(&Vec3f, &Vec3f) -> cmp::Ordering; 3] = [
    sortx, sorty, sortz,
];


impl KDTree {
    pub fn new(points: &[Vec3f]) -> Self {
        let sorted_points = points.iter().map(|&f| f).collect::<Vec<_>>();
        sorted_points.sort_unstable_by(f32::total_cmp);
        let median =

        // assert non-empty... assert no nans anywhere.
        unimplemented!()
    }

    fn recur_by(points: &mut [Vec3f], depth: usize) {
        if points.is_empty() {
            return 
        }
        // do something different if points is empty
        points.sort_unstable_by(SORT_FNS[axis]);
        let median = points.len() / 2;
        let location = match depth % 3 {
            0 => points[median].0,
            1 => points[median].1,
            2 => points[median].2,
        };
        let (below, above) = points.split_at_mut(median);
        let left = Box::new(Self::recur_by(below, depth+1));
        let right = Box::new(Self::recur_by(above, depth+1));
        Self { location, left, right }
    }

    pub fn nearest(point: &Vec3f) -> &'a Vec3f {

    }
}


#[cfg(test)]
mod cfg {
    #[test]
    fn fuzzy() {
        // a bunch of random numbers...
        let random_numbers = [
            Vec3f(0.5696993218985669, 13.345861485731302, 7.76935996985861),
            Vec3f(9.690789392205627, 9.027699420721893, 9.346277087864818),
            Vec3f(10.21989972183257, 4.826826268925308, 14.937874981564061),
            Vec3f(5.633985506801158, 2.5827113482509607, 13.150665183908115),
            Vec3f(13.577561203105335, 10.587782880527934, 9.053992056437657),
            Vec3f(2.97282415863539, 1.0438736566093887, 2.34243533622141),
            Vec3f(13.159202420266046, 3.9752727824914684, 7.10740366284869),
            Vec3f(10.085898531810004, 3.14488094634388, 6.593714061625147),
            Vec3f(9.602235029606113, 12.233607666926233, 14.443511677104821),
            Vec3f(7.581007327356424, 11.45398658164354, 10.697012449122262),
            Vec3f(6.30433834506116, 7.756345218884755, 2.225472700009683),
            Vec3f(11.707937793135983, 7.430815762731047, 7.530415819931349),
            Vec3f(11.801878727810623, 13.681093907350682, 4.76895507001363),
            Vec3f(4.3115646410414925, 6.709195059508045, 14.530519003446337),
            Vec3f(12.635796028892674, 3.607887861082249, 10.26153377713388),
            Vec3f(6.6194370336977615, 12.48287868135064, 3.03771316110163),
            Vec3f(2.2619633190784554, 11.325306586910054, 12.413332448095016),
            Vec3f(12.064090258605507, 9.349783505488965, 5.786255635005667),
            Vec3f(12.154597200143147, 9.559668424090411, 6.309715863019292),
            Vec3f(10.865187939778751, 11.0831872401614, 4.014402972110293),
            Vec3f(0.6318437857790782, 3.6217979880033835, 9.894181667065235),
            Vec3f(11.601929463393132, 14.034870078870131, 10.726817797228453),
            Vec3f(7.7205493032125085, 4.632818072600157, 4.119288311933619),
            Vec3f(1.403355780097748, 13.386159724040787, 3.939232915699943),
        ];

        let testnos = [
            Vec3f(8.614451683103807, 5.864976311664861, 10.795482784556897),
            Vec3f(10.539304465860809, 3.68696266977598, 1.8727492170366493),
            Vec3f(2.463190734179576, 8.385724003324047, 13.620769917760471),
            Vec3f(9.766655557519444, 4.427433672286515, 0.52370618299029),
            Vec3f(12.128885870745364, 11.51873231530006, 6.700937765247913),
            Vec3f(7.5028247416878555, 14.146023205601464, 13.582049861725002),
            Vec3f(6.129263647966207, 11.398876440393334, 8.269454228853535),
            Vec3f(1.169820932846679, 10.252944472504998, 9.841841824805199),
            Vec3f(9.075350091329751, 1.542440325415576, 11.049651060512595),
            Vec3f(13.175481324533994, 12.16468597417916, 4.272312968924399),
            Vec3f(1.250328148604693, 8.71348812448346, 12.443163717926756),
            Vec3f(4.7277170678333205, 3.404980433596882, 3.182665803374186),
            Vec3f(5.357259896506595, 9.227538209103175, 7.273313487967628),
            Vec3f(1.0770747029789973, 9.39609327791265, 4.031818482614045),
            Vec3f(12.804964199211673, 13.491300335868589, 1.2257644744050444),
            Vec3f(10.033617156284807, 7.7149958097024305, 4.605534263771169),
            Vec3f(7.4145122080073245, 3.4642615845422817, 1.1150455821156973),
            Vec3f(9.370992222744727, 10.395687672325208, 9.1834018774071),
            Vec3f(10.963728942827407, 4.357911147428094, 11.059543441227671),
            Vec3f(4.250662381119231, 1.3725063382300495, 0.5058813050245892),
            Vec3f(4.018329492986267, 10.857361869945505, 11.212765002792603),
            Vec3f(10.808575922578239, 8.720767812828559, 9.692345904045233),
            Vec3f(3.1421543594143726, 4.94526236652365, 3.494824401028028),
            Vec3f(11.285238101178518, 7.531513968138281, 14.239548247872824),
            Vec3f(12.195970610913728, 3.3399480580693637, 2.910503432694729),
            Vec3f(12.598289999723177, 7.312749086172857, 2.107965286482842),
            Vec3f(3.670577259908385, 2.09529834648027, 0.4515007424815115),
            Vec3f(0.42050346044444964, 5.250470186342255, 0.8740426878652496),
            Vec3f(5.812203339722977, 11.876499668531896, 13.652886993225392),
            Vec3f(11.483368451669541, 3.8369576528557374, 4.830023832707991),
        ];

        for testno in testnos.iter() {
            let r_min = random_numbers.iter()
                .min_by_key(|r| testno.sq_dist(r));
        }
    }
}
